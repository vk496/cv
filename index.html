<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.12.0/devicon.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"
        integrity="sha256-Rdw90D3AegZwWiwpibjH9wkBPwS9U4bjJ51ORH8H69c=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script>

        var oYAML // Where our YAML is stored
        var ACTIVEPROJECTS = new Set()

        function consumeSkills() {
            let base_skill = document.getElementById('template_skill')
            let parent_skill = document.getElementById('parent_skill');
            oYAML.skills.forEach(function (yitem, index) {
                //get node
                var clone2 = document.importNode(base_skill.content, true);

                // Name
                var skillName = Object.keys(yitem)[0];
                var item = clone2.querySelector('label')

                // Set name
                item.querySelector('span').textContent = skillName;
                // item.textContent = skillName;
                // Fix reference of label to the input
                var itemInput = clone2.querySelector('input')

                itemInput.setAttribute('id', 'skill' + index)
                itemInput.setAttribute('skillcontent', skillName)
                item.setAttribute('for', 'skill' + index)
                item.setAttribute('skillname', skillName)

                // If we have a icon, we should set it

                if (yitem[skillName] != null && 'logo' in yitem[skillName]) {
                    logoContent = yitem[skillName].logo
                    // Logo defined, decide what it is
                    switch (true) {
                        case logoContent.startsWith('fa') || logoContent.startsWith('devicon'):
                            item.querySelector('i')
                                .setAttribute('class', logoContent)
                            break;
                        case logoContent.startsWith('/'):
                            var iconname = logoContent.substring(1);
                            (new FontFace(iconname, 'url(icons/' + iconname + '.woff)')).load().then(function (loaded_face) {
                                // Add font to page
                                document.fonts.add(loaded_face);
                                document.body.style.fontFamily = iconname;

                                // Inject CSS
                                var styles = ".myicon-" + iconname + ":before { content: \"\\" + iconname + "\"; font-family: " + iconname + " !important; }"
                                var styleSheet = document.createElement("style")
                                styleSheet.type = "text/css"
                                styleSheet.innerText = styles
                                document.head.appendChild(styleSheet)
                            })

                            ic = item.querySelector('i')
                                .setAttribute('class', 'myicon-' + iconname);
                            break;
                        default:
                            // nothing to do
                            break;
                    }
                }

                // clone2.querySelector('input').setAttribute('id', 'skill' + index)
                parent_skill.insertBefore(clone2, base_skill);
            });
        }

        function consumeExperience() {
            let base_experience = document.getElementById('template_experience');
            let parent_experience = document.getElementById('parent_experience');

            oYAML.education_experience
                .map(elem => {
                    if (!elem.stop) {
                        elem.stop = new Date()
                    }
                    return elem
                })
                .sort((a, b) => { return a.start < b.start })
                .forEach(function (item) {
                    var clone2 = document.importNode(base_experience.content, true);
                    // Year
                    startDate = (new Date(item.start))
                    stopDate = (new Date((item.stop)))
                    clone2.querySelector(".cv-year").textContent = startDate.getFullYear() + " - " + stopDate.getFullYear()

                    // Name
                    clone2.querySelector(".cv-name").textContent = item.name

                    // Description
                    clone2.querySelector(".cv-description").textContent = item.description

                    // Location
                    if (item.location) {
                        clone2.querySelector(".cv-location").textContent = item.location.city
                    }

                    // Insert
                    parent_experience.insertBefore(clone2, base_experience);
                });
        }

        function callbackSortProjects(a, b) {
            // If still ongoing project, 
            // priorize newer
            if (!a.stop || !b.stop) {
                return a.start < b.start
            }
            return a.stop < b.stop
        }

        function consumeProjects() {
            let base_projects = document.getElementById('template_projects');
            let parent_projects = document.getElementById('parent_projects');
            oYAML.projects
                // .map(elem => {
                //     if (!elem.stop) {
                //         d = new Date()
                //         // d.setFullYear(d.getFullYear())
                //         elem.stop = d
                //     }
                //     return elem
                // })
                .sort(callbackSortProjects)
                .forEach(function (item, idx) {
                    var clone2 = document.importNode(base_projects.content, true);
                    // Year
                    stopDate = (new Date((item.stop)))
                    startDate = (new Date((item.start)))

                    // if range is too short, just show the month
                    if (startDate.getFullYear() == stopDate.getFullYear()) {
                        clone2.querySelector(".cv-year").textContent = stopDate.getFullYear() + " " + startDate.toLocaleDateString("en", { month: 'short' }) + "-" + stopDate.toLocaleDateString("en", { month: 'short' })
                    } else {
                        clone2.querySelector(".cv-year").textContent = startDate.getFullYear() + " - " + (stopDate.getFullYear() || "Present")
                    }

                    // Name
                    clone2.querySelector(".cv-name").textContent = item.name

                    // Description
                    clone2.querySelector(".cv-description").textContent = item.description

                    // Save default sorting order
                    clone2.querySelector(".cv-project").setAttribute('projectorder', idx)

                    // Insert
                    parent_projects.insertBefore(clone2, base_projects);
                });
        }


        function FindSkills(title, highlight = true) {
            if (!title) {
                console.log("Title is empty")
                return
            }

            otarget = oYAML.projects
                .find(o => o.name === title)

            if (!otarget) {
                console.log("No object with name " + title)
                return
            }

            $('div#parent_skill')
                .children('.cv-skill')
                .filter((idx, item) => otarget.tags.includes(item.getAttribute("skillname")))
                .toggleClass('btn-secondary', highlight)
                .toggleClass('btn-outline-primary', !highlight)

        }

        function extendSkillsUsedBy(initialArray) {
            // Iterate just 1 level
            if (!initialArray || initialArray.length == 0) {
                return
            }

            var ret = []
            oYAML.skills
                .forEach(function (yitem, index) {
                    var skillName = Object.keys(yitem)[0];
                    if (initialArray.includes(skillName)) {
                        ret.push(skillName)
                        if (yitem[skillName] != null && 'usedby' in yitem[skillName]) {
                            Array.prototype.push.apply(ret, yitem[skillName].usedby)
                        }
                    }

                });

            return ret

        }

        function getNamesfromSkills(skillsArray) {
            // Iterate just 1 level
            if (!skillsArray || skillsArray.length == 0) {
                return
            }

            var ret = oYAML.projects
                .filter((item, idx) =>
                    item.tags
                        .some(r =>
                            skillsArray.indexOf(r) >= 0
                        )
                )
                .sort(callbackSortProjects)
                .map(e => e.name)

            return ret
        }

        function highlightProjectCard($projectCard, ishighlight) {
            $projectCard
                .toggleClass('bg-primary text-white', ishighlight)
                .find('.cv-year')
                .toggleClass('text-muted', !ishighlight)
                .toggleClass('text-white-75', ishighlight)
        }

        $(document).ready(function () {
            // Define a custom jquery function to insert children elements at specific index.
            // 
            // $("#controller").insertAt(0, "<div>first insert</div>");
            // $("#controller").insertAt(-1, "<div>append</div>");
            // $("#controller").insertAt(1, "<div>insert at second position</div>");
            jQuery.fn.insertAt = function (index, element) {
                var lastIndex = this.children().length;
                if (index < 0) {
                    index = Math.max(0, lastIndex + 1 + index);
                }
                this.append(element);
                if (index < lastIndex) {
                    this.children().eq(index).before(this.children().last());
                }
                return element;
            }



            function consumeData() {
                // Init Skills array
                consumeSkills()

                consumeExperience()

                consumeProjects()

                $(function () {
                    // Skill click
                    $("#parent_skill").on("change", function () {
                        var user_selected = $('#parent_skill').children('input[type=checkbox]:checked').map(function () {
                            return this.getAttribute('skillcontent')
                        }).get()

                        // If is empty, reset default positions
                        if (user_selected.length == 0) {
                            var $wrapper = $('#parent_projects');

                            highlightProjectCard($wrapper
                                .children('.cv-project, .bg-primary'), false)

                            $wrapper
                                .find('.cv-project')
                                .sort(function (a, b) {
                                    return +a.getAttribute('projectorder') - +b.getAttribute('projectorder');
                                })
                                .appendTo($wrapper);

                            return
                        }

                        var targetSkills = extendSkillsUsedBy(user_selected)
                        var firstPositions = getNamesfromSkills(targetSkills)

                        // Get elements which must unhighlight
                        firstPositions
                            .forEach(projectName => ACTIVEPROJECTS.delete(projectName))

                        // unhighlight
                        ACTIVEPROJECTS
                            .forEach(projectName => {
                                var $projectDiv = $("#parent_projects")
                                    .find(".cv-project .cv-name:contains(" + projectName + ")")
                                    .closest('.cv-project')
                                highlightProjectCard($projectDiv, false)
                            })

                        // Save last status
                        ACTIVEPROJECTS = new Set(firstPositions)

                        firstPositions.forEach(function (projectName, index) {
                            var $projectDiv = $("#parent_projects")
                                .find(".cv-project .cv-name:contains(" + projectName + ")")
                                .closest('.cv-project')

                            

                            // We can't move it if it is already the first one
                            if ($projectDiv.index() > 0) {
                                $projectDiv.fadeOut('fast', function () {
                                    //highlight the card
                                    highlightProjectCard($projectDiv, true)
                                    $("#parent_projects")
                                        .insertAt(index, $projectDiv)
                                        .fadeIn('slow');
                                });
                            } else {
                                highlightProjectCard($projectDiv, true)
                            }
                            
                        });
                        // console.log("xd")
                    });


                    // Mouse over projects
                    $(".cv-project").mouseenter(function () {
                        // $(this).css("box-shadow", "5px 5px 5px 2px #555");
                        $(this).toggleClass('border-secondary')
                        FindSkills(
                            $(this).find(".cv-name").text(),
                            true
                        )
                    });
                    $(".cv-project").mouseleave(function () {
                        // $(this).css("box-shadow", "0px 0px 0px 0px #555");
                        $(this).toggleClass('border-secondary')
                        FindSkills(
                            $(this).find(".cv-name").text(),
                            false
                        )
                    });
                });

            }

            // ##############
            // Start here :)
            // ##############
            fetch('cv.yml')
                .then(response => {
                    if (!response.ok) throw new Error(response.status);
                    return response.text()
                })
                .then(data => {
                    oYAML = jsyaml.load(data)
                    consumeData();
                })
            // .catch((error) => alert(error))

        });

    </script>

    <title>Hello, world!</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-3 border">
                <div class="row mb-2">
                    <h2>Contact</h2>
                    <div id="firstname">Valentín KIVACHUK BURDÁ</div>
                    <div id="email">cv@vk496.es</div>
                </div>
                <div class="row">
                    <h2>Languages</h2>
                    <div>Spanish</div>
                </div>
                <div class="row">
                    <h2>Skills</h2>
                    <div id="parent_skill" class="row row-cols-auto btn-group" role="group">
                        <template id="template_skill">
                            <input type="checkbox" class="btn-check" id="btncheck1" autocomplete="off"
                                skillcontent="XXX">
                            <label class="btn btn-outline-primary m-1 cv-skill" for="btncheckX"><i class=""></i>
                                <span>XXX</span></label>
                        </template>
                    </div>
                </div>
            </div>
            <div class="col h-100 border">
                <!-- Education & Experience -->

                <h2>Education & Experience</h2>
                <div id="parent_experience" class="container">
                    <template id="template_experience">
                        <div class="row border cv-experience">
                            <div class="col-2 border cv-year">
                                <!-- 2014-2018 -->
                            </div>
                            <div class="col border cv-name">
                                <!-- Erasmus Internship -->
                            </div>
                            <div class="col-3 border cv-location">
                                <!-- NXP Semiconductors -->
                            </div>
                            <div class="row">
                                <div class="col-auto offset-2 border cv-description">
                                    <!--  -->
                                </div>
                            </div>
                        </div>
                    </template>
                </div>


                <!-- Projects -->

                <h2>Projects</h2>
                <div class="container">
                    <div id="parent_projects" class="row justify-content-evenly">
                        <template id="template_projects">
                            <div class="card col-5 my-2 border cv-project">
                                <div class="card-body">
                                    <h4 class="card-title cv-name">
                                        Erasmus Internship
                                    </h4>
                                    <h6 class="card-subtitle mb-2 text-muted cv-year">
                                        2014-2018
                                    </h6>

                                    <p class="card-text cv-description">
                                        Lorem Ipsum
                                    </p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>

</html>